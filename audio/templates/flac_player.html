{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>üé∂ FLAC Player</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        canvas {
            margin-top: 20px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h2>üéß FLAC & MP3 Web Player</h2>

    <!-- Controles -->
    <button onclick="prevTrack()">‚èÆÔ∏è Anterior</button>
    <button onclick="startPlayback()">‚ñ∂Ô∏è Tocar</button>
    <button onclick="nextTrack()">‚è≠Ô∏è Pr√≥xima</button>
    <br><br>

    <!-- Controle de Volume -->
    <label for="volumeControl">üîä Volume:</label>
    <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" onchange="setVolume(this.value)">

    <!-- Player de √°udio oculto -->
    <audio id="flacPlayer" hidden></audio>

    <!-- Canvas para visualiza√ß√£o -->
    <canvas id="visualizer" width="600" height="100"></canvas>

    <!-- Dados da playlist -->
    <script id="flac-data" type="application/json">
        {{ flac_urls|safe }}
    </script>

    <!-- Script principal -->
    <script>
        const playlist = JSON.parse(document.getElementById("flac-data").textContent);
        const player = document.getElementById("flacPlayer");
        let index = 0;

        // Inicializa faixa
        function loadTrack(i) {
            player.src = playlist[i];
            player.load();
        }

        function playNext() {
            index = (index + 1) % playlist.length;
            loadTrack(index);
            player.play();
        }

        function prevTrack() {
            index = (index - 1) % playlist.length;
            loadTrack(index);
            player.play();
        }

        function startPlayback() {
            loadTrack(index);
            player.play();
        }

        function setVolume(value) {
            player.volume = value;
        }

        // Visualizador
        const canvas = document.getElementById("visualizer");
        const ctx = canvas.getContext("2d");

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaElementSource(player);
        const analyser = audioCtx.createAnalyser();
        source.connect(analyser);
        analyser.connect(audioCtx.destination);

        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function draw() {
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = canvas.width / bufferLength;
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i];
                ctx.fillStyle = "purple";
                ctx.fillRect(i * barWidth, canvas.height - barHeight, barWidth - 1, barHeight);
            }
        }

        // Inicia visualizador ao tocar
        player.onplay = () => {
            audioCtx.resume();  // Reativo em contextos modernos
            draw();
        };

        // Reproduz pr√≥xima faixa automaticamente
        player.addEventListener('ended', playNext);
    </script>
</body>
</html>

